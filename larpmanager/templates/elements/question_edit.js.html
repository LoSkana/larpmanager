{% load i18n static %}
<script>
window.addEventListener('DOMContentLoaded', function() {

    // ========== Context Detection ==========

    // Detect if we're in writing or registration context
    function isWritingContext() {
        return window.location.pathname.indexOf('/writing/form/') > -1;
    }

    // Extract writing type from URL (for writing forms)
    function getWritingType() {
        const pathParts = window.location.pathname.split('/');
        const formIndex = pathParts.indexOf('form');
        return formIndex >= 0 ? pathParts[formIndex + 1] : null;
    }

    // Extract question UUID from current URL path
    function getQuestionUuidFromUrl() {
        const pathParts = window.location.pathname.split('/');
        const questionUuidIndex = pathParts.indexOf('edit') + 1;
        return pathParts[questionUuidIndex];
    }

    // Build base path up to /manage/
    function getBasePath() {
        const pathParts = window.location.pathname.split('/');
        const manageIndex = pathParts.indexOf('manage');
        return pathParts.slice(0, manageIndex + 1).join('/');
    }


    // ========== URL Building ==========

    // Build URL for options AJAX endpoint
    function buildOptionsAjaxUrl(optionUuid, questionUuid) {
        const basePath = getBasePath();

        if (isWritingContext()) {
            const writingType = getWritingType();
            return `${basePath}/writing/options/${writingType}/ajax/${optionUuid}/?question_uuid=${questionUuid}`;
        } else {
            return `${basePath}/options/ajax/${optionUuid}/?question_uuid=${questionUuid}`;
        }
    }

    // Build URL for options edit endpoint
    function buildOptionsEditUrl(optionUuid) {
        const basePath = getBasePath();

        if (isWritingContext()) {
            const writingType = getWritingType();
            return `${basePath}/writing/options/${writingType}/edit/${optionUuid}/`;
        } else {
            return `${basePath}/options/edit/${optionUuid}/`;
        }
    }


    // ========== Page Navigation ==========

    // Reload page with scroll_to parameter
    function reloadWithScrollToOptions() {
        const currentUrl = window.location.href.split('?')[0].split('#')[0];
        window.location.href = currentUrl + '?scroll_to=options';
    }

    // Check URL params and scroll to options if needed
    function checkAndScrollToOptions() {
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.get('scroll_to') === 'options') {
            // Wait for toggleOptions to complete and options to be visible
            setTimeout(function() {
                toggleOptions();

                // Scroll to options if visible
                if ($('#options').length && $('#options').is(':visible')) {
                    window.jump_to('#options');
                }
            }, 400);

            // Remove scroll_to parameter from URL without reloading
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }


    // ========== Modal Management ==========

    // Close option modal popup
    function closeOptionModal() {
        // Simulate click on overlay to close uglipop properly
        const overlay = document.getElementById('uglipop_overlay');
        if (overlay) {
            overlay.click();
        }
    }

    // Open option modal with form in iframe
    function openOptionModal(optionUuid, questionUuid) {
        let editUrl = buildOptionsEditUrl(optionUuid);

        if (optionUuid === '0') {
            editUrl += `?question_uuid=${questionUuid}&frame=1`;
        } else {
            editUrl += '?frame=1';
        }

        frame = "<iframe src='{0}' width='100%' height='100%'></iframe>".format(editUrl);

        uglipop({
            class: 'popup_option',
            source: 'html',
            content: frame
        });

    }


    // ========== AJAX Utilities ==========

    // Make AJAX request with common error handling
    function makeAjaxRequest(config) {
        start_spinner();

        return $.ajax(config)
            .done(function(response) {
                stop_spinner();
                if (config.onSuccess) {
                    config.onSuccess(response);
                }
            })
            .fail(function(xhr, status, error) {
                stop_spinner();
                if (config.onError) {
                    config.onError(xhr, status, error);
                } else {
                    alert('{% trans "An error occurred" %}');
                }
            });
    }

    // Save question via AJAX before adding options
    function saveQuestionBeforeAddingOption(callback) {
        const $mainForm = $('#main_form');
        const formData = new FormData($mainForm[0]);

        makeAjaxRequest({
            url: window.location.pathname,
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            dataType: "json",
            onSuccess: function(response) {
                if (response.success && response.question_uuid) {
                    // Update URL with new question UUID
                    const newUrl = window.location.pathname.replace('/edit/0', '/edit/' + response.question_uuid);
                    window.history.replaceState({}, '', newUrl);

                    // Execute callback with question UUID
                    if (callback) {
                        callback(response.question_uuid);
                    }
                } else {
                    // Form has validation errors, submit normally to show errors
                    $mainForm.off('submit');
                    $mainForm.submit();
                }
            },
            onError: function() {
                // AJAX error, submit form normally to show errors
                $mainForm.off('submit');
                $mainForm.submit();
            }
        });
    }


    // ========== Form Field Visibility ==========

    // Toggle visibility of form fields based on question type
    function toggleOptions() {
        const selectedValue = $('#id_typ').val();
        const speed = 300;

        // Options section visibility
        if (["m", "s"].includes(selectedValue)) {
            if (!$('#options').is(':visible')) {
                $('#options').fadeIn(speed);
            }
        } else {
            if ($('#options').is(':visible')) {
                $('#options').fadeOut(speed);
            }
        }

        // Max length field visibility
        const maxLengtheable = ["m", "t", "p", "e", "name", "teaser", "text", "title", "additional_tickets"];
        $('#id_max_length_tr').toggle(maxLengtheable.includes(selectedValue));

        // Printable and visibility fields
        if (["s", "m", "t", "p", "e", "c"].includes(selectedValue)) {
            $('#id_printable_tr').fadeIn(speed);
            $('#id_visibility_tr').fadeIn(speed);
        } else {
            $('#id_printable_tr').fadeOut(speed);
            $('#id_visibility_tr').fadeOut(speed);
        }

        // Hide visibility for specific types
        if (["name", "teaser", "text", "faction"].includes(selectedValue)) {
            $('#id_visibility_tr').fadeOut(speed);
        }

        // Status field visibility
        if (["ticket", "c"].includes(selectedValue)) {
            $('#id_status_tr').fadeOut(speed);
        } else {
            $('#id_status_tr').fadeIn(speed);
        }

        // Editable field visibility
        if (["c"].includes(selectedValue)) {
            $('#id_editable_tr').fadeOut(speed);
        } else {
            $('#id_editable_tr').fadeIn(speed);
        }
    }


    // ========== Event Handlers ==========

    // Handle "New Option" button click
    function handleNewOptionClick(e) {
        e.preventDefault();
        const questionUuid = getQuestionUuidFromUrl();

        // If question hasn't been saved yet, save it first
        if (questionUuid === "0") {
            saveQuestionBeforeAddingOption(function(savedQuestionUuid) {
                openOptionModal('0', savedQuestionUuid);
            });
        } else {
            openOptionModal('0', questionUuid);
        }

        return false;
    }

    // Handle edit option link click
    function handleEditOptionClick(e) {
        e.preventDefault();
        const optionUuid = $(this).data('option-uuid');
        const questionUuid = getQuestionUuidFromUrl();
        openOptionModal(optionUuid, questionUuid);
        return false;
    }

    // Listen for messages from iframe to close modal when option is saved or cancelled
    window.addEventListener('message', function(e) {
        // Check if message is from our option form
        if (e.data && e.data.type === 'option_saved') {
            closeOptionModal();
            reloadWithScrollToOptions();
        } else if (e.data && e.data.type === 'option_cancelled') {
            closeOptionModal();
        }
    });


    // ========== Initialization ==========

    $(document).ready(function() {
        // Move options section before submit button
        $('#options').insertBefore('#form_submit');

        // Initialize visibility toggle
        setTimeout(toggleOptions, 10);

        // Check if we need to scroll to options
        checkAndScrollToOptions();

        // Bind event handlers for question type changes
        $('#id_typ').on('change', toggleOptions);
        $('#id_status').on('change', toggleOptions);

        // Bind event handlers for option management
        $('.new-option').on('click', handleNewOptionClick);
        $(document).on('click', '.edit-option-ajax', handleEditOptionClick);

        // Handle cancel button in option modal (using event delegation for dynamic content)
        $(document).on('click', '.btn-cancel', function(e) {
            e.preventDefault();
            closeOptionModal();
            return false;
        });
    });

});
</script>
