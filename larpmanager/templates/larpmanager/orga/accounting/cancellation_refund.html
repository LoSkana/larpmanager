{% extends "utils.html" %}
{% load show_tags i18n %}
{% block title %}
    {% trans "Refund for" %} - {{ registration.stration }}
{% endblock title %}
{% block info %}
    {% trans "Manage refund for a participant who has cancelled" %}
{% endblock info %}
{% block content %}
    <h3>{% trans "Payment" %}</h3>
    <table class="tablesorter">
        <tr>
            <th>{% trans "Registration fee" %}</th>
            <th>{% trans "Actual paid" %}</th>
            <th>{% trans "Money" %}</th>
            {% if features.tokens %}<th>{{ tokens_name }}</th>{% endif %}
            {% if features.credits %}<th>{{ credits_name }}</th>{% endif %}
        </tr>
        <tr>
            <td id="tot_iscr">
                {% if registration.tot_iscr %}{{ registration.tot_iscr | floatformat:"0" }}{% endif %}
            </td>
            <td id="tot_payed"></td>
            <td id="pay_money">
                {% if registration.payments.a %}{{ registration.payments.a | floatformat:"0" }}{% endif %}
            </td>
            {% if features.tokens %}
                <td id="pay_token">
                    {% if registration.payments.c %}{{ registration.payments.c | floatformat:"0" }}{% endif %}
                </td>
            {% endif %}
            {% if features.credits %}
                <td id="pay_credit">
                    {% if registration.payments.b %}{{ registration.payments.b | floatformat:"0" }}{% endif %}
                </td>
            {% endif %}
        </tr>
    </table>
    <h3>{% trans "Returning" %}</h3>
    <table class="tablesorter">
        <tr>
            <th>{% trans "Retention" %}</th>
            <th>{% trans "Full returning" %}</th>
            {% if features.tokens %}<th>{{ tokens_name }}</th>{% endif %}
            {% if features.credits %}<th>{{ credits_name }}</th>{% endif %}
        </tr>
        <tr>
            <td id="ref_tot"></td>
            <td id="ref"></td>
            {% if features.tokens %}<td id="ref_token">0</td>{% endif %}
            {% if features.credits %}<td id="ref_credit">0</td>{% endif %}
        </tr>
    </table>
    <h3>{% trans "Returning type" %}</h3>
    {% if not features.tokens and not features.credits %}
        <div class="alert alert-warning">
            {% trans "Warning: Neither tokens nor credits features are enabled. Refunds cannot be processed as virtual currency." %}
        </div>
    {% elif features.tokens and not features.credits %}
        <div class="nav typ">
            <a id="typ_t" href="#" onclick="return select_typ('t');" class="sel">{% trans "Only" %} {{ tokens_name }}</a>
        </div>
    {% elif features.credits and not features.tokens %}
        <div class="nav typ">
            <a id="typ_c" href="#" onclick="return select_typ('c');" class="sel">{% trans "Only" %} {{ credits_name }}</a>
        </div>
    {% else %}
        <div class="nav typ">
            <a id="typ_t" href="#" onclick="return select_typ('t');">{% trans "Only" %} {{ tokens_name }}</a>
            <a id="typ_c" href="#" onclick="return select_typ('c');">{{ tokens_name }} {% trans "e" %} {{ credits_name }}</a>
        </div>
    {% endif %}
    <br />
    <h3>{% trans "Returning percentage" %}</h3>
    <div class="nav p">
        {% for i in '0123456789'|make_list %}
            <a id="p_{{ forloop.counter }}"
               href="#"
               onclick="return select_p('{{ forloop.counter }}');">{{ forloop.counter }}0 %</a>
        {% endfor %}
    </div>
    <br />
    <h3>{% trans "Approve reimbursement" %}</h3>
    <form id="ref" action="{{ request.path }}" method="post">
        {% csrf_token %}
        <input type="hidden" id="inp_token" name="inp_token" value="0" />
        <input type="hidden" id="inp_credit" name="inp_credit" value="0" />
        <input type="submit" value="{% trans "Confirm" %}">
    </form>
{% endblock content %}
{% block js %}
    <script>
var typ = null;
var perc = null;

function compute() {
    if ((typ == null) || (perc == null)) return;

    var pay_money = parseInt($('#pay_money').html()) || 0;
    var pay_token = parseInt($('#pay_token').html()) || 0;
    var pay_credit = parseInt($('#pay_credit').html()) || 0;
    var tot_pay = pay_money + pay_token + pay_credit;
    $('#tot_payed').html(tot_pay);

    var rest_tot = Math.ceil(tot_pay / 100.0 * perc);
    $('#ref_tot').html(tot_pay - rest_tot);

    var rest = Math.max(0, rest_tot - (tot_pay - tot_pay));
    $('#ref').html(rest);

    if (typ == 't') {
        var token_elem = $('#ref_token');
        if (token_elem.length) {
            token_elem.html(rest);
            $('#inp_token').val(rest);
        }

        var credit_elem = $('#ref_credit');
        if (credit_elem.length) {
            credit_elem.html('0');
            $('#inp_credit').val('0');
        }
        return;
    }

    var ref_token = Math.min(rest, pay_token);
    rest -= pay_token;

    var token_elem = $('#ref_token');
    if (token_elem.length) {
        token_elem.html(ref_token);
        $('#inp_token').val(ref_token);
    }

    var credit_elem = $('#ref_credit');
    if (credit_elem.length) {
        credit_elem.html(rest);
        $('#inp_credit').val(rest);
    }

}

function select_typ(id) {
    $('.typ a').removeClass('sel');
    $('#typ_' + id).addClass('sel');

    typ = id;

    compute();

    return false;
}

function select_p(id) {
    $('.p a').removeClass('sel');
    $('#p_' + id).addClass('sel');

    perc = parseInt(id) * 10;

    compute();

    return false;
}

window.addEventListener('DOMContentLoaded', function() {
    $(document).ready(function(){
        // Select default type based on available features
        {% if features.tokens %}
            select_typ('t');
        {% elif features.credits %}
            select_typ('c');
        {% endif %}
        select_p('7');

        $('form').on('submit', function() {
            {% if not features.tokens and not features.credits %}
                if (!window.lmTesting) alert('{% filter escapejs %}{% trans "Cannot process refund: Neither tokens nor credits features are enabled" %}{% endfilter %}');
                return false;
            {% else %}
                return window.lmTesting ? true : confirm('{% filter escapejs %}{% trans "Are you really sure" %}{% endfilter %}?');
            {% endif %}
        });
    });
});
    </script>
{% endblock js %}
