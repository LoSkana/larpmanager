{% extends "utils.html" %}
{% load i18n %}
{% block title %}
    {% trans "Cargo manifest" %} - {{ run }}
{% endblock title %}
{% block info %}
    {% trans "This page shows the cargo manifest, and the status of each item assignment" %}
{% endblock info %}
{% block content %}
    {% include "elements/header/edit.html" %}
    {% for area_id, area in area_list.items %}
        <h2>{{ area }}</h2>
        {% if area.position %}
            <p>
                <b>{% trans "Position" %}:</b> {{ area.position }}
            </p>
        {% endif %}
        {% if area.description %}
            <p>
                <b>{% trans "Description" %}:</b> {{ area.description }}
            </p>
        {% endif %}
        <table id="inv_manifest_itm_{{ area.id }}"
               class="go_datatable dot_links"
               no_header_cols="{{ no_header_cols }}">
            <thead>
                <tr>
                    <th></th>
                    <th>{% trans "Item" %}</th>
                    <th>{% trans "Container" %}</th>
                    <th>{% trans "Loaded" %}</th>
                    {% if optionals.quantity %}
                        <th>{% trans "Quantity" %}</th>
                    {% endif %}
                    <th>{% trans "Notes" %}</th>
                    <th>{% trans "Photo" %}</th>
                    <th>{% trans "Deployed" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for el in area.items %}
                    <tr id="{{ el.id }}">
                        <td>
                            <a href="{% url 'orga_warehouse_assignment_item_edit' run.get_slug el.id %}"
                               qtip="{% trans "Edit" %}"><i class="fas fa-edit"></i></a>
                        </td>
                        <td>{{ el.item }}</td>
                        <td>
                            {{ el.item.container }}
                            {% if el.item.container.position %}- {{ el.item.container.position | truncatechars:50 }}{% endif %}
                        </td>
                        <td data-order="{% if el.loaded %}1{% else %}0{% endif %}"
                            class="ajax-toggle"
                            tp="load">
                            <span class="value {% if not el.loaded %}hide{% endif %}"><i class="fa-solid fa-check"></i></span>
                        </td>
                        {% if optionals.quantity %}
                            <td>
                                {% if el.quantity %}{{ el.quantity }}{% endif %}
                            </td>
                        {% endif %}
                        <td>{{ el.notes }}</td>
                        <td>
                            {% if el.item.photo %}
                                <img src="{{ el.item.thumb.url }}"
                                     class="inv_photo"
                                     alt="item photo"
                                     style="cursor: pointer"
                                     onclick="openImage('{{ el.item.photo.url }}')" />
                            {% endif %}
                        </td>
                        <td data-order="{% if el.deployed %}1{% else %}0{% endif %}"
                            class="ajax-toggle"
                            tp="depl">
                            <span class="value {% if not el.deployed %}hide{% endif %}"><i class="fa-solid fa-check"></i></span>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
    <div id="imagePopup">
        <img id="popupImg" src="" alt="popup image" />
    </div>
{% endblock content %}
{% block js %}
    <script>
// Show photo

function openImage(url) {
    document.getElementById('popupImg').src = url;
    document.getElementById('imagePopup').style.display = 'flex';
}

document.getElementById('imagePopup').onclick = function() {
    this.style.display = 'none';
};

// Keep scroll on refresh

  const KEY = "page-wrapper.scrollTop";

  function getScroller() {
    return document.getElementById("page-wrapper");
  }

  function save() {
    const el = getScroller();
    if (!el) return;
    sessionStorage.setItem(KEY, String(el.scrollTop || 0));
  }

  function restore() {
    const el = getScroller();
    if (!el) return false;
    const val = sessionStorage.getItem(KEY);
    if (val == null) return true;
    const y = parseInt(val, 10) || 0;
    el.scrollTop = y;
    // doppio pass per layout tardivo
    requestAnimationFrame(() => { el.scrollTop = y; });
    setTimeout(() => { el.scrollTop = y; }, 50);
    return true;
  }

  function attach() {
    const el = getScroller();
    if (!el) return false;
    el.addEventListener("scroll", save, { passive: true });
    window.addEventListener("pagehide", save);
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") save();
    });
    return true;
  }

  let reloadTimer = null;
  function scheduleReload(ms) {
    clearTimeout(reloadTimer);
    reloadTimer = setTimeout(function () {
      save();
      location.reload();
    }, ms);
  }

  function initRefreshScroll() {
    if (!attach()) {
      // attacca quando il nodo diventa disponibile
      const obs = new MutationObserver(() => {
        if (attach()) obs.disconnect();
      });
      obs.observe(document.documentElement, { childList: true, subtree: true });
    }
    const tryRestore = () => {
      if (restore()) return;
      // ritenta finchÃ© #page-wrapper non esiste
      setTimeout(tryRestore, 30);
    };
    tryRestore();

    // standard reload: 10s
    scheduleReload(10000);

  }



window.addEventListener('DOMContentLoaded', function() {
    $( function() {

        initRefreshScroll();

        // Server-side update of loaded and deployed

        $(".ajax-toggle").on("click", function (e) {
            const box = $(this);
            const value = box.find(".value:visible").length > 0;
            const tr = box.closest("tr");
            const idx = tr.attr("id");
            const type = $(this).attr("tp");
            const assignment = $(this).attr("ass");

            const newValue = !value;

            const table = box.closest("table").DataTable();

            // if pressed, add 5s to reload
            scheduleReload(5000);

            $.ajax({
                url: "{% url 'orga_warehouse_assignment_manifest' run.get_slug %}",
                method: "POST",
                data: { idx: idx, type: type, assignment: assignment, value: newValue },
                success: function () {
                    box.children().toggle(newValue);
                    box.attr('data-order', newValue ? '1' : '0');
                    table.row(box.closest('tr')).invalidate('dom').draw(false);
                },
                error: function (res) {
                    $.toast({
                        text: res,
                        showHideTransition: 'slide',
                        icon: 'error',
                        position: 'mid-center',
                        textAlign: 'center',
                        allowToastClose: true,
                        hideAfter: false,
                        stack: 1
                    });
                }
            });
        });

    });
});

    </script>
{% endblock js %}
