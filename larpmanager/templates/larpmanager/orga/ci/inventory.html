{% extends "utils.html" %}
{% load i18n %}
{% block title %}
    {% trans "Character Inventory" %}: {{ inventory.name }}
{% endblock title %}
{% block content %}
    <style>
        .ci-transfer-cell {
            padding: 0.2em;
        }
        .ci-transfer-form {
            display: flex;
            flex-direction: column;
            gap: 0.2em;
        }
        .ci-transfer-row {
            display: flex;
            gap: 0.2em;
            align-items: center;
            text-align: center;
        }
        .ci-transfer-add-row {
            display: flex;
            gap: 0.2em;
            align-items: center;
            justify-content: center;
        }
        .ci-amount-input {
            width: 3em;
            margin: 0;
            padding: 0.1em;
        }
        .ci-amount-input-add {
            width: 4em;
            margin: 0;
            padding: 0.1em;
        }
        .ci-target-select {
            width: auto;
            min-width: 4em;
            margin: 0;
            padding: 0.1em;
        }
        .ci-submit-btn {
            margin: 0;
            padding: 0.2em 0.4em;
        }
        .ci-reason-container {
            text-align: center;
        }
        .ci-reason-input {
            width: 90%;
            margin: 0 auto;
            padding: 0.1em;
        }
        .ci-empty-row {
            text-align: center;
        }
    </style>
    <h2>{% trans "Currencies & Materials" %}</h2>
    <table class="mob ">
        <tr>
            <th>{% trans "Name" %}</th>
            <th>{% trans "Available" %}</th>
            <th>{% trans "Transfer" %}</th>
            <th>{% trans "Add" %}</th>
        </tr>
        {% for entry in pool_balances_list %}
            <tr>
                <td>{{ entry.type.name }}</td>
                <td>{{ entry.balance.amount }}</td>
                <td class="ci-transfer-cell">
                    <form method="post"
                          action="{% url 'orga_ci_transfer' run.get_slug %}"
                          class="ci-transfer-form">
                        {% csrf_token %}
                        <input type="hidden" name="source_inventory" value="{{ inventory.id }}">
                        <input type="hidden" name="pool_type" value="{{ entry.type.id }}">
                        <div class="ci-transfer-row">
                            <input type="number"
                                   name="amount"
                                   min="1"
                                   max="{{ entry.balance.amount }}"
                                   class="ci-amount-input">
                            <select name="target_inventory" class="ci-target-select">
                                <option value="">NPC</option>
                                {% for inv in all_inventories %}
                                    {% if inv.id != inventory.id %}<option value="{{ inv.id }}">{{ inv.name }}</option>{% endif %}
                                {% endfor %}
                            </select>
                            <button type="submit" class="ci-submit-btn">Transfer</button>
                        </div>
                        <div class="ci-reason-container">
                            <input type="text"
                                   name="reason"
                                   placeholder="{% trans "Reason" %}"
                                   class="ci-reason-input">
                        </div>
                    </form>
                </td>
                <td>
                    {% if can_edit_from_npc %}
                        <form method="post"
                              action="{% url 'orga_ci_transfer' run.get_slug %}"
                              class="ci-transfer-form">
                            {% csrf_token %}
                            <input type="hidden" name="source_inventory" value="">
                            {# NPC = None #}
                            <input type="hidden" name="target_inventory" value="{{ inventory.id }}">
                            <input type="hidden" name="pool_type" value="{{ entry.type.id }}">
                            <div class="ci-transfer-add-row">
                                <input type="number"
                                       name="amount"
                                       min="1"
                                       placeholder="Amount"
                                       class="ci-amount-input-add">
                                <button type="submit" class="ci-submit-btn">{% trans "Add from NPC" %}</button>
                            </div>
                            <div class="ci-reason-container">
                                <input type="text"
                                       name="reason"
                                       placeholder="{% trans "Reason" %}"
                                       class="ci-reason-input">
                            </div>
                        </form>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
    </table>
    <h2>{% trans "Transfer Log" %}</h2>
    <table class="mob tight">
        <tr>
            <th>{% trans "Time" %}</th>
            <th>{% trans "Actor" %}</th>
            <th>{% trans "From" %}</th>
            <th>{% trans "To" %}</th>
            <th>{% trans "Resource" %}</th>
            <th>{% trans "Amount" %}</th>
            <th>{% trans "Reason" %}</th>
        </tr>
        {% for t in transfers %}
            <tr>
                <td>{{ t.timestamp|date:"Y-m-d H:i" }}</td>
                <td>{{ t.actor|default:"-" }}</td>
                <td>{{ t.source_inventory.name|default:"NPC" }}</td>
                <td>{{ t.target_inventory.name|default:"NPC" }}</td>
                <td>{{ t.pool_type.name }}</td>
                <td>{{ t.amount }}</td>
                <td>{{ t.reason }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="7" class="ci-empty-row">{% trans "No transfers yet." %}</td>
            </tr>
        {% endfor %}
    </table>
{% endblock content %}
